{{- if .Values.externalSecret }}
{{- $apiVersion := ternary "external-secrets.io/v1" "external-secrets.io/v1beta1" (has "external-secrets.io/v1" .Capabilities.APIVersions) -}}
{{- $type := .Values.externalSecret.type }}
{{- $storeName := .Values.externalSecret.secretStoreName }}
{{- $secretPath := .Values.externalSecret.secretPath }}
{{- $refreshInterval := .Values.externalSecret.refreshInterval | default "1m" }}

# Deployment secrets
{{- range $appName, $appConfig := .Values.apps }}

  {{- range $containerType := list "containers" "initContainers" }}
    {{- range $name, $config := index $appConfig $containerType }}
      {{- if $config.secrets }}
        {{- template "standard-app.externalSecret" (dict
            "apiVersion" $apiVersion
            "name" $name
            "labels" (merge (dict "app" $appName "product" $.Release.Name) (default dict $.Values.labels))
            "secrets" $config.secrets
            "type" $type
            "storeName" $storeName
            "secretPath" $secretPath
            "refreshInterval" $refreshInterval
            "Values" $.Values
            "Release" $.Release
          ) }}
---
      {{- end }}
    {{- end }}
  {{- end }}

  {{- if $appConfig.secrets }}
    {{- template "standard-app.externalSecret" (dict
        "apiVersion" $apiVersion
        "name" $appName
        "labels" (merge (dict "app" $appName "product" $.Release.Name) (default dict $.Values.labels))
        "secrets" $appConfig.secrets
        "type" $type
        "storeName" $storeName
        "secretPath" $secretPath
        "refreshInterval" $refreshInterval
        "Values" $.Values
        "Release" $.Release
      ) }}
---
  {{- end }}

{{- end }}

# Jobs
{{- range $jobName, $jobConfig := .Values.jobs }}
  {{- if $jobConfig.secrets }}
    {{- template "standard-app.externalSecret" (dict
        "apiVersion" $apiVersion
        "name" $jobName
        "labels" (merge (dict "app" $jobName "product" $.Release.Name) (default dict $.Values.labels))
        "secrets" $jobConfig.secrets
        "type" $type
        "storeName" $storeName
        "secretPath" $secretPath
        "refreshInterval" $refreshInterval
        "Values" $.Values
        "Release" $.Release
      ) }}
---
  {{- end }}
{{- end }}

# CronJobs
{{- range $cronjobName, $cronjobConfig := .Values.cronjobs }}
  {{- range $containerType := list "containers" "initContainers" }}
    {{- range $name, $config := index $cronjobConfig $containerType }}
      {{- if $config.secrets }}
        {{- template "standard-app.externalSecret" (dict
            "apiVersion" $apiVersion
            "name" $name
            "labels" (merge (dict "app" $cronjobName "product" $.Release.Name) (default dict $.Values.labels))
            "secrets" $config.secrets
            "type" $type
            "storeName" $storeName
            "secretPath" $secretPath
            "refreshInterval" $refreshInterval
            "Values" $.Values
            "Release" $.Release
          ) }}
---
      {{- end }}
    {{- end }}
  {{- end }}

  {{- if $cronjobConfig.secrets }}
    {{- template "standard-app.externalSecret" (dict
        "apiVersion" $apiVersion
        "name" $cronjobName
        "labels" (merge (dict "app" $cronjobName "product" $.Release.Name) (default dict $.Values.labels))
        "secrets" $cronjobConfig.secrets
        "type" $type
        "storeName" $storeName
        "secretPath" $secretPath
        "refreshInterval" $refreshInterval
        "Values" $.Values
        "Release" $.Release
      ) }}
---
  {{- end }}
{{- end }}


# Global secret
{{- if .Values.secrets }}
  {{- template "standard-app.externalSecret" (dict
      "apiVersion" $apiVersion
      "name" $.Release.Name
      "labels" (merge (dict "app" $.Release.Name) (default dict $.Values.labels))
      "secrets" .Values.secrets
      "type" $type
      "storeName" $storeName
      "secretPath" $secretPath
      "refreshInterval" $refreshInterval
      "Values" $.Values
      "Release" $.Release
    ) }}
---
{{- end }}
{{- end }}

{{ range $appName, $appConfig := .Values.apps }}
{{- $appValues := dict
      "component" $appName
      "Values"    $.Values
      "Release"   $.Release
      "labels"    (default (dict) $.Values.labels)
    -}}
{{- if $appConfig.hpa }}
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: {{ $appName }}
  labels:
    {{- include "standard-app.labels" $appValues | nindent 2 }}
spec:
  maxReplicas: {{ $appConfig.hpa.maxReplicas }}
  minReplicas: {{ $appConfig.hpa.minReplicas }}
  scaleTargetRef:
    apiVersion: {{ if $appConfig.rollout }}argoproj.io/v1alpha1{{ else }}apps/v1{{ end }}
    kind: {{ if $appConfig.rollout }}Rollout{{ else }}Deployment{{ end }}
    name: {{ $appName }}
  metrics:
  {{- with $appConfig.hpa.memoryTarget }}
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: {{ . }}
  {{- end }}
  {{- with $appConfig.hpa.cpuTarget }}
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: {{ . }}
  {{- end }}
---
{{- end }}
{{- end }}
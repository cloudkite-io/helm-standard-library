{{ range $appName, $appConfig := .Values.apps }}
{{- $appValues := dict
      "component" $appName
      "Values"    $.Values
      "Release"   $.Release
      "labels"    (default (dict) $.Values.labels)
    -}}
{{- if $appConfig.vpa }}
apiVersion: autoscaling.k8s.io/v1
kind: VerticalPodAutoscaler
metadata:
  name: {{ $appName }}
  {{- include "standard-app.labels" $appValues | nindent 2 }}
spec:
  targetRef:
    apiVersion: {{ if $appConfig.rollout }}argoproj.io/v1alpha1{{ else }}apps/v1{{ end }}
    kind:       {{ if $appConfig.rollout }}Rollout{{ else }}Deployment{{ end }}
    name:       {{ $appName }}
  updatePolicy:
    updateMode: {{ $appConfig.vpa.mode | default "Off" }}
  {{- with $appConfig.vpa.resources }}
  resourcePolicy:
    containerPolicies:
      - containerName: '*'
        controlledResources: ["cpu", "memory"]
        controlledValues: RequestsAndLimits
        {{- toYaml . | nindent 8}}
  {{- end }}
---
{{- end }}
{{- end }}
image: us-central1-docker.pkg.dev/cloudkite-infra-ops/cloudkite-docker-images/example-image
tag: example_tag
pvcs: # A list Persistent Volume Claims that can be mounted to the pods
  - name: pvc1
    storage: 2Gi
    storageClassName: my-storage-class # Optional (If not provided it defaults to the default storage class)
    accessModes:
      - ReadWriteOnce
  ## Use if deploying on the GKE spot nodes (e.g. for NAP)
  # nodeType: spot
labels:
  label1: somevalue
  label2: anothervalue

ingress:  # NOTE: >0.8.0 DEPRECATES this, USE .Values.ingresses
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
    nginx.ingress.kubernetes.io/configuration-snippet: |
      rewrite ^(/api)(.*) $2 break;
  # hostPaths:
  #   - host: "my.domain.name.com"
  #     servicePort: 3000
  #     serviceName: cloudkite-app-1
  #     path: "/"
  #   - host: "my-other.domain.name.com"
  #     servicePort: 3000
  #     serviceName: cloudkite-app-1
  #     path: "/someprefix"
  # tls:
  #   - secretName: my-domain-name-com-tls
  #     hosts:
  #       - "my.domain.name.com"
  #       - "my-other.domain.name.com"
  hosts:
    - test.dev.someorg.com
    - other.domain.name.com
  paths:
    - path: /
      pathType: Prefix
      servicePort: 5000
      serviceName: cloudkite-app-1
    - path: /api
      pathType: Prefix
      servicePort: 3003
      serviceName: cloudkite-app-2

ingresses:
  cloudkite-app-1-webhook:
    # ingressClass: set this to override the ingress class used for the ingress (if not set, 
    # the ingress will use the ingress class set as defualt in the cluster)
    ingressClass: nginx-external
    annotations:
      kubernetes.io/tls-acme: "true"
      ingress.kubernetes.io/ssl-redirect: "true"
    hosts:
      - test-callbacks.dev.someorg.com
    paths:
      - path: /webhook
        pathType: Prefix
        servicePort: 5000
        serviceName: cloudkite-app-1
  # additional ingresses are optional
  cloudkite-app-2-webhook:
    annotations:
      kubernetes.io/tls-acme: "true"
      ingress.kubernetes.io/ssl-redirect: "true"
    hosts:
      - test-callbacks.dev.someotherorg.com
    paths:
      - path: /webhook
        pathType: Prefix
        servicePort: 5000
        serviceName: cloudkite-app-2

env:
  GLOBAL_ENV1: value1
  GLOBAL_ENV2: value2

serviceAccounts:
  app-1:
    annotations:
      eks.amazonaws.com/role-arn: arn:aws:iam::ACCOUNT_ID:role/ASSUME_ROLE_NAME
  app-2:
    annotations:
      iam.gke.io/gcp-service-account: GOOGLE_SERVICE_ACCOUNT_NAME@PROJECT_ID.iam.gserviceaccount.com

apps:
  # you can specify init containers and containers for each deployment for a fine tuning (example-app-1), or use a simplified version in case you only need one container (example-app-2)
  # you can specify parameters on multiple levels: 
  #     * global (env, secrets)
  #     * app/deployment and container/initcontainer (env, secrets, service, redinessProbe, resources)
  example-app-1:
    initContainers:
      exampleinitcontainer-1:
        image: google/cloud-sdk
        command: ["/bin/sh", "-c"]
        args:
          - /etc/scripts/script1.sh
        secrets:
          data:
            - secretKey: SOURCE_PROJECT_ID
          dataFrom:
            version: version-number
    containers:
      example-container-1:
        image: us-central1-docker.pkg.dev/cloudkite-infra-ops/cloudkite-docker-images/app-1
        tag: tag-1
        imagePullPolicy: None
        # mpa:
        #   mode: noset
        #   maxReplicas: 12
        #   minReplicas: 3
        #   cpuTarget: 75
        service:
          name: tcp
          type: ClusterIP
          port: 5000
          targetPort: 5000
          protocol: TCP
        readinessProbe:
          httpGet:
            path: /healthcheck
            port: 3001
          initialDelaySeconds: 5
          periodSeconds: 10
          successThreshold: 1
          failureThreshold: 5
          timeoutSeconds: 5
        livenessProbe:
          httpGet:
            path: /healthcheck
            port: 3001
          initialDelaySeconds: 5
          periodSeconds: 30
          successThreshold: 1
          failureThreshold: 5
          timeoutSeconds: 5
        resources:
          limits:
            memory: 1Gi
          requests:
            cpu: 300m
            memory: 1Gi
        env:
          CONTAINER_ENV1: asd
          CONTAINER_ENV2: qwe
    hpa:
      maxReplicas: 3
      minReplicas: 2
      cpuTarget: 50
      # memoryTarget: 95
    replicas: 2
    env:
      APP_ENV1: foo
      APP_ENV2: bar
    secrets:
      data:
        - secretKey: appsettings.json
          property: APPSETTINGS_JSON
        - secretKey: SOURCE_PROJECT_ID
      dataFrom:
        version: version-number
    serviceMonitor:
      path: /metrics # default /metrics
      interval: 60s # default 30s
      port: portname
      scrapeTimeout: 10s # default 30s


  example-app-2:
    serviceAccount: cloudkite
    vpa:
      mode: Auto
      ## You can specify resources gap for VPA
      # resources:
      #   minAllowed:
      #     memory: 2Gi
      #   maxAllowed:
      #     memory: 4Gi
    # rollout: true
    service:
      name: tcp
      type: ClusterIP
      port: 3003
      targetPort: 3003
      protocol: TCP
    resources:
      limits:
        memory: 1Gi
      requests:
        cpu: 150m
        memory: 1Gi
    env:
      ENV1: default
    # secrets:
      # data:
      #   - MONGO_URL
      #   - REDISCLOUD_URL
      #   - DATABASE_URL
      # dataFrom:
      #   version: version-number

  example-app-3:
    serviceAccount: cloudkite
    vpa:
      mode: Auto
    volumes: 
      - name: static
        mountPath: /static
        type:
          emptyDir: {}
      - name: my-configmap-volume
        mountPath: /etc/scripts
        type:
          configMap:
            name: static-gen-script
            defaultMode: 0777
        configMapData:
          test_script.sh: |
            #!/bin/bash
            DATE=$(date +%d_%m)
  
  example-app-4:
    serviceAccount: cloudkite
    hpa:
      maxReplicas: 3
      minReplicas: 2
      cpuTarget: 80
    replicas: 2
    pdb:
      minAvailable: 2
    vpa:
      mode: Auto
    volumes: 
      - name: static
        type:
          emptyDir: {}
      - name: scripts
        type:
          configMap:
            name: static-gen-script
            defaultMode: 0777
        configMapData:
          test_script.sh: |
            #!/bin/bash
            DATE=$(date +%d_%m)
    initContainers:
      gen-static:
        command:
          - "/usr/local/bin/scripts/test_script.sh"
        volumes:
          - name: scripts
            mountPath: /usr/local/bin/scripts
          - name: static
            mountPath: /var/static
    containers:
      my-app:
        volumes:
          - name: static
            mountPath: /etc/html/static

externalSecret:
  ## Hashicorp Vault
  # secretStoreName: example-name
  # type: vault
  # refreshInterval: 15s
  # secretPath: example-path

  ## AWS secrets manager
  # secretStoreName: example-name
  # type: aws
  # refreshInterval: 1m
  # secretPath: example-path

  # Google Secret Manager
  secretStoreName: example-name
  type: gcp
  refreshInterval: 15s

  # Azure Key Vault
  # secretStoreName: example-name
  # type: azure
  # refreshInterval: 15s

secrets:
  data:
  # Vault/GCP/AWS Example
  - secretKey: AWS_ACCESS_KEY_ID   # - secretKey: & property: atribute for secrets are applicable to version 0.2.0, version 0.1.0 uses the key id without artribut names e.g (- AWS_ACCESS_KEY_ID)
  - secretKey: AWS_SECRET_ACCESS_KEY
  # Azure Example
  # Serilog__WriteTo__0__Args__connectionString: SERILOG_CONNECTION_STRING
  # TokenConfig__Secret: TOKEN_CONFIG_SECRET
  # dataFrom:
  #   version: version-number

jobs:
  jobexample-1:
    annotations:
      annotation1: value1
    command:
      - "cmd1"
    args:
      - "arg1"
    restartPolicy: OnFailure
    resources:
      requests:
        memory: 0.5Gi
        cpu: 50m
      limits:
        memory: 0.5Gi

cronjobs:
  cronjobexample-1:
    schedule: 0 6 * * *
    resources:
      requests:
        memory: 0.5Gi
      limits:
        memory: 0.5Gi
    # image: 
      # repository: dasdqw
    containers:
      cronjobexample-1:
        args: ["node", "bin/updatereviewsfromproducts.js"]
        # image:
          # repository: setaer
        

  cronjobexample-2:
    schedule: 0 3 * * 0
    serviceAccount: cronjobexample-2
    image: asdasd
    volumes: 
      - name: db-backups
        mountPath: /db-backups
        type:
          emptyDir: {}
      - name: my-configmap-volume
        mountPath: /etc/scripts
        type:
          configMap:
            name: db-backups-scripts
        configMapData:
          test_script.sh: |
            #!/bin/bash
            DATE=$(date +%d_%m)
    #'{{ .Files.Get "scripts/test_script.sh" | nindent 4 }}' we are currently working on making configMap script data workable from a repo that's not standard library, for now you can use it like this.
        

    initContainers:
      exampleinitcontainer-1:
        image: google/cloud-sdk
        command: ["/bin/sh", "-c"]
        args:
          - /etc/scripts/script1.sh
        secrets:
          data:
            - secretKey: SOURCE_PROJECT_ID
          dataFrom:
            version: version-number


      exampleinitcontainer-2:
        image: asdasd
        args: 
          - gsutil 
          - cp 
          - -r
          - gs://cloudkite-bucket/path
          - /db-backups/

    containers:
      examplecontainer:
        image: us-central1-docker.pkg.dev/cloudkite-infra-ops/cloudkite-docker-images/cloudkite
        tag: stage
        command: ["/bin/sh", "-c"]
        args: ["node", "example_app.js"]
        secrets:
          data:
            - secretKey: appsettings.json
              property: APPSETTINGS_JSON
            - secretKey: SOURCE_PROJECT_ID
          dataFrom:
            version: version-number
